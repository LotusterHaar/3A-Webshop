<?php 
require_once($_SERVER['DOCUMENT_ROOT'].'/../protectedfunctions/generalfunctions.php');
require_once($_SERVER['DOCUMENT_ROOT'].'/../protectedfunctions/dbfunctions.php');

parse_str($_SERVER['QUERY_STRING'], $queryresolved);

if (isset($queryresolved['id']) && !empty($queryresolved['id'])) {
    $artikelid=$queryresolved['id'];


    //Get extra info about the category
    $database = db_con();
    $sql = "SELECT * FROM `product` WHERE Disabled!=1 AND ID=:productid";
    $stmt = $database->prepare($sql);
    $stmt->execute( [
        ':productid' => $artikelid,
    ]);
    $artikel = $stmt->fetch(PDO::FETCH_ASSOC);
    $artikel['ProductName']=htmlentities($artikel['ProductName']);
    $artikel['Description']=htmlentities($artikel['Description']);
    $artikel['FullDescription']=htmlspecialchars($artikel['FullDescription'], ENT_QUOTES);

    $database=null;

    if ($artikel['Stock']>0) {
        $opvoorraad='Ja';
    } else {
        $opvoorraad='Nee';
    }
}
else {
die();
}

?>

            <!-- Content -->
            <section class="content">
                <div class="column">
                    <div class="buttonRow">
                        <button class="button buttonBack"><a href="/webshop/producten/"><i
                                class="far fa-arrow-alt-circle-left fa-lg"></i> Terug</a>
                        </button>
                    </div>
                    <div class="row1">
                        <div class="productImage">
                            <img src="/webshop/producten/images/<?php echo ($artikel['Picture_Big']); ?>" alt="Image <?php echo (trim($artikel['ProductName'])); ?>">
                        </div>

                        <div class="productInfo">
                            <article>
                                <div class="nameProduct">
                                    <h1><?php echo (trim($artikel['ProductName'])); ?></h1>
                                    <h2>€ <?php echo ($artikel['Price']); ?></h2>
                                </div>
                                <div class="descriptionInStock">
                                    <div class="description">
                                        <p><?php echo ($artikel['FullDescription']); ?></p>
                                    </div>
                                    <div class="inStock">
                                        <p><b>Op voorraad: <?php echo ($opvoorraad); ?></b></p>
                                    </div>
                                </div>
                                <div class="productToCart">
                                    <form method="get">
                                        <label class="form-item" for="input-number"><strong>Aantal: <?php echo ($artikel['Stock']) ?></strong></label>
                                        <input class="form-item" id="input-number" type="text" size="3" name="amount"
                                               value="1">
                                        <?php if ($opvoorraad=='Ja') { echo ('<button class="form-item button" type="submit"><i class="fa fa-cart-plus"
                                                                                          aria-hidden="true"></i>
                                            Toevoegen aan winkelwagen
                                        </button>');
                                        } else {
                                            echo ('<button class="form-item button rood" type="submit" name="notify" value="'.$artikel['ID'].'"><i class="fa shipping-fast"
                                                                                                     aria-hidden="true"></i>
                                        Artikel niet op voorraad. Bericht zodra op voorraad
                                    </button>');
                                        } ?>
                                    </form>
                                </div>
                            </article>
                        </div>
                    </div>
                    <div class="row2">
                    <?php
                    $database = db_con();
                    $sql = "SELECT * FROM `product_related_product` WHERE ProductID=:productid";
                    $stmt = $database->prepare($sql);
                    $stmt->execute( [
                    ':productid' => $artikelid,
                    ]);
                    $gerelateerde_artikelen = $stmt->fetchAll(PDO::FETCH_ASSOC);
                    $database=null;
                    foreach ($gerelateerde_artikelen as $gerelateerd_artikel) {
                        $database = db_con();
                        $sql = "SELECT * FROM `product` WHERE Disabled!=1 AND ID=:productid";
                        $stmt = $database->prepare($sql);
                        $stmt->execute( [
                        ':productid' => $gerelateerd_artikel['ProductID_Related_Product'],
                        ]);
                        $product = $stmt->fetch(PDO::FETCH_ASSOC);
                        $product['ProductName']=htmlentities($product['ProductName']);
                        $product['Description']=htmlentities($product['Description']);
                        $product['Price']=htmlentities($product['Price']);
                        $database=null;

                        echo('<a href="/webshop/producten/productinfo?id='.$product['ID'].'">
                        <article class="imageBoxSmall">
                        <img src="/webshop/producten/images/'.$product['Picture_Small'].'" alt="Instrument">');
                        echo('<h1>');

                        echo(substr($product['ProductName'],0, 50));
                        echo('</h1>');
                        echo('<div class="priceline"><h2>');
                        echo('€ '.$product['Price']);
                        echo('</h2></a>');
                        $querystring='';
                        unset ($queryresolved['toevoegen']);
                        foreach ($queryresolved as $key => $value ){
                        if (empty($querystring))
                        $querystring = '?'.$key.'='.$value;
                        else
                        $querystring = $querystring.'&'.$key.'='.$value;
                        }

                        if (isLoggedin()) {
                            echo ('<div class="shopping-cart-button"><a href="'.$querystring.'&toevoegen='.$product['ID'].'">');
                            echo ('<i class="fa fa-cart-plus" aria-hidden="true"></i></a></div>'."\r\n                ");
                        } else {
                            echo('<div class="shopping-cart-button"><a href="/webshop/registreren"><span>');
                            echo ('<i class="fa fa-user-plus" aria-hidden="true"></i></span></a></div>');
                        }
                        echo('</div></article>');
                    }
                echo('</div>');
                    ?>

                <?php
                    $database = db_con();
                    $sql = "SELECT AVG(BeoordelingsCijfer) AS AVGRATE FROM `review` WHERE ProductID=:productid";
                    $stmt = $database->prepare($sql);
                    $stmt->execute( [
                        ':productid' => $artikelid,
                    ]);
                    $result = $stmt->fetch(PDO::FETCH_ASSOC);
                    $gemiddelde = $result['AVGRATE'];
                    print_r($gemiddelde);

                    $totaal_aantal = 0;
                    for($i=1; $i<=5; $i++)
                    {
                            $sql = "SELECT count(BeoordelingsCijfer) as Totaal from `review` where ProductID=:productid and BeoordelingsCijfer=:cijfer ";
                            $stmt = $database->prepare($sql);
                            $stmt->execute( [
                            ':productid' => $artikelid,
                            ':cijfer' => $i,
                            ]);
                            $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
                            print_r($result);
                            $product[$i]=$result[0]['Totaal'];
                            $totaal_aantal += $product[$i];
                    }
                print_r($product);
                print($product[4]);
                ?>


                <article id="userRatings">

                    <span class="heading">Reviews</span>
                    <span class="fa fa-star checked"></span>
                    <span class="fa fa-star checked"></span>
                    <span class="fa fa-star checked"></span>
                    <span class="fa fa-star checked"></span>
                    <span class="fa fa-star"></span>
                    <p><strong><?php echo(round($gemiddelde,2));?></strong> van de 5, gebaseerd op <?php echo($totaal_aantal);?> reviews.</p>
                    <hr>

                    <div class="rowUserRating">
                        <div class="side">
                            <div>5 sterren</div>
                        </div>
                        <div class="middle">
                            <div class="bar-container">
                                <div class="bar-5"></div>
                            </div>
                        </div>
                        <div class="side right">
                            <div><?php echo($product[5]);?></div>
                        </div>
                        <div class="side">
                            <div>4 sterren</div>
                        </div>
                        <div class="middle">
                            <div class="bar-container">
                                <div class="bar-4"></div>
                            </div>
                        </div>
                        <div class="side right">
                            <div><?php echo($product[4]);?></div>
                        </div>
                        <div class="side">
                            <div>3 sterren</div>
                        </div>
                        <div class="middle">
                            <div class="bar-container">
                                <div class="bar-3"></div>
                            </div>
                        </div>
                        <div class="side right">
                            <div><?php echo($product[3]);?></div>
                        </div>
                        <div class="side">
                            <div>2 sterren</div>
                        </div>
                        <div class="middle">
                            <div class="bar-container">
                                <div class="bar-2"></div>
                            </div>
                        </div>
                        <div class="side right">
                            <div><?php echo($product[2]);?></div>
                        </div>
                        <div class="side">
                            <div>1 sterren</div>
                        </div>
                        <div class="middle">
                            <div class="bar-container">
                                <div class="bar-1"></div>
                            </div>
                        </div>
                        <div class="side right">
                            <div><?php echo($product[1]);?></div>
                        </div>
                    </div>
                </article>

                <div class="wrap-collabsible">
                    <input id="collapsible" class="toggle" type="checkbox">
                    <label for="collapsible" class="lbl-toggle">Reviews</label>
                    <div class="collapsible-content">
                        <div class="content-inner">
                            <p>
                                Ik vind deze gitaar helemaal geweldig, het is het beste instrument dat ik ooit bespeelt
                                heb. De klanken zijn hemels. Het design is ook perfect!

                            </p>
                        </div>
                    </div>
                </div>

            </section>
            <!-- Footer -->
            <footer>
                TuneShop © 2019 | Jan Willem Lenting & Lotus ter Haar
            </footer>
        </div>
        <!-- Sidebar -->
        <aside class="sidebar">
            Sidebar
        </aside>
    </div>
</main>
</body>
</html>