<?php 
require_once($_SERVER['DOCUMENT_ROOT'].'/../protectedfunctions/generalfunctions.php');
require_once($_SERVER['DOCUMENT_ROOT'].'/../protectedfunctions/dbfunctions.php');
require_once($_SERVER['DOCUMENT_ROOT'].'/../protectedfunctions/user.php');

parse_str($_SERVER['QUERY_STRING'], $queryresolved);

if (isset($queryresolved['id']) && !empty($queryresolved['id'])) {
    $artikelid=$queryresolved['id'];

    //Get extra info about the category
    $database = db_con();
    $sql = "SELECT * FROM `product` WHERE Disabled!=1 AND ID=:productid";
    $stmt = $database->prepare($sql);
    $stmt->execute( [
        ':productid' => $artikelid,
    ]);
    $artikel = $stmt->fetch(PDO::FETCH_ASSOC);
    $artikel['ProductName']=htmlentities($artikel['ProductName']);
    $artikel['Description']=htmlentities($artikel['Description']);
    $artikel['FullDescription']=htmlspecialchars($artikel['FullDescription'], ENT_QUOTES);

    $database=null;

    if ($artikel['Stock']>0) {
        $opvoorraad='Ja';
    } else {
        $opvoorraad='Nee';
    }
}
else {
die();
}
?>
            <!-- Content -->
            <section class="content">
                <div class="column">
                    <div class="buttonRow">
                        <button class="button buttonBack"><a href="/webshop/producten/"><i
                                class="far fa-arrow-alt-circle-left fa-lg"></i> Terug</a>
                        </button>
                    </div>
                    <div class="row1">
                        <div class="productImage">
                            <img src="/webshop/producten/images/<?php echo ($artikel['Picture_Big']); ?>" alt="Image <?php echo (trim($artikel['ProductName'])); ?>">
                    </div>

                        <div class="productInfo">
                            <article>
                                <div class="nameProduct">
                                    <h1><?php echo (trim($artikel['ProductName'])); ?></h1>
                                    <h2>€ <?php echo ($artikel['Price']); ?></h2>
                                </div>
                                <div class="descriptionInStock">
                                    <div class="description">
                                        <p><?php echo ($artikel['FullDescription']); ?></p>
                                    </div>
                                    <div class="inStock">
                                        <p><b>Op voorraad: <?php echo ($opvoorraad); ?></b></p>
                                    </div>
                                </div>
                                <div class="productToCart">
                                    <form method="get" action="#">
                                        <input class="form-item" id="input-number" type="number" size="3" name="amount"
                                               value="1">
                                        <?php if ($opvoorraad=='Ja') { echo ('<button class="form-item button"  name="toevoegen" value="'.$artikel['ID'].'" type="submit"><i class="fa fa-cart-plus"
                                                                                          aria-hidden="true"></i>
                                            Toevoegen aan winkelwagen
                                        </button>');
                                        } else {
                                            echo ('<button class="form-item button rood" type="submit" name="notify" value="'.$artikel['ID'].'"><i class="fa shipping-fast"
                                                                                                     aria-hidden="true"></i>
                                        Artikel niet op voorraad. Bericht zodra op voorraad
                                    </button>');
                                        } ?>
                                    </form>
                                </div>
                            </article>
                        </div>
                    </div>
                    <div class="row2">
                    <?php
                    $database = db_con();
                    $sql = "SELECT * FROM `product_related_product` WHERE ProductID=:productid";
                    $stmt = $database->prepare($sql);
                    $stmt->execute( [
                    ':productid' => $artikelid,
                    ]);
                    $gerelateerde_artikelen = $stmt->fetchAll(PDO::FETCH_ASSOC);

                    $database=null;
                    foreach ($gerelateerde_artikelen as $gerelateerd_artikel) {
                        $database = db_con();
                        $sql = "SELECT * FROM `product` WHERE Disabled!=1 AND ID=:productid";
                        $stmt = $database->prepare($sql);
                        $stmt->execute( [
                        ':productid' => $gerelateerd_artikel['ProductID_Related_Product'],
                        ]);
                        $product = $stmt->fetch(PDO::FETCH_ASSOC);
                        if($product != null){
                            $product['ProductName']=htmlentities($product['ProductName']);
                            $product['Description']=htmlentities($product['Description']);
                            $product['Price']=htmlentities($product['Price']);
                            $database=null;

                            echo('<a href="/webshop/producten/productinfo?id='.$product['ID'].'">
                            <article class="imageBoxSmall">
                            <img src="/webshop/producten/images/'.$product['Picture_Small'].'" alt="Instrument">');
                            echo('<h1>');

                            echo(substr($product['ProductName'],0, 50));
                            echo('</h1>');
                            echo('<div class="priceline"><h2>');
                            echo('€ '.$product['Price']);
                            echo('</h2></a>');
                            $querystring='';
                            unset ($queryresolved['toevoegen']);
                            foreach ($queryresolved as $key => $value ){
                            if (empty($querystring))
                            $querystring = '?'.$key.'='.$value;
                            else
                            $querystring = $querystring.'&'.$key.'='.$value;
                            }

                            if (isLoggedin()) {
                                echo ('<div class="shopping-cart-button"><a href="'.$querystring.'&toevoegen='.$product['ID'].'">');
                                echo ('<i class="fa fa-cart-plus" aria-hidden="true"></i></a></div>'."\r\n                ");
                            } else {
                                echo('<div class="shopping-cart-button"><a href="/webshop/registreren"><span>');
                                echo ('<i class="fa fa-user-plus" aria-hidden="true"></i></span></a></div>');
                            }
                            echo('</div></article>');
                        }
                    }
                echo('</div>');
                    ?>

                <?php

                    $review = reviewinfo($artikelid);
                ?>


                <article id="userRatings">

                    <span class="heading">Reviews</span>

                    <?php

                    $fraction = $review['gemiddelde'] - floor($review['gemiddelde']);
                    $fraction = round($fraction * 2) / 2;  // Rond op halve punt
                    $review['gemiddelde'] = floor($review['gemiddelde']) + $fraction;  // Bepaal getal op halve punt
                    $floor = floor($review['gemiddelde']);
                    $fraction = $review['gemiddelde'] - $floor;

                    $ceil = ceil($review['gemiddelde']);
                    if ($fraction < 0.6)
                        $halfstar = $fraction / 0.5;
                    else
                        $halfstar = 0;

                    for ($i = 1; $i <= $floor; $i++) {
                        echo ('<span class="fa fa-star checked"></span>'."\r\n");
                    }

                    for( $i= 1 ; $i <= $halfstar ; $i++ ) {
                        echo ('<span class="fa fa-star-half-alt checked"></span>'."\r\n");
                    }

                    for ($i = 5; $i > $ceil; $i--) {
                        echo ('<span class="fa fa-star"></span>'."\r\n");
                    }

                    ?>
                    <p><strong><?php echo($review['gemiddelde']);?></strong> van de 5, gebaseerd op <?php echo($review['totaal_aantal']);?> reviews. (afgerond op 0.5 punt)</p>
                    <hr>

                    <div class="rowUserRating">
                        <?php for ($i = 5; $i > 0; $i--) { ?><div class="side">
                            <div><?php echo ($i); ?> sterren</div>
                        </div>
                        <div class="middle">
                            <div class="bar-container">
                                <div class="bar-<?php echo ($i); ?>" style="width: <?php if ($review['product'][$i]>0) echo ($review['product'][$i]/$review['totaal_aantal']*100); else echo('0'); // Dit is de enige plek waar we expres inline css doen ?>%"></div>
                            </div>
                        </div>
                        <div class="side right">
                            <div><?php echo($review['product'][$i]);?></div>
                        </div>
                        <?php } ?>
                    </div>
                </article>

                <?php if ($review['gemaakt']==0): ?>
                <div class="buttonReviewRow">
                    <button class="button buttonReview"><?php echo('<a href="/webshop/reviews/review?id='.$artikelid.'" target="_blank">');?>
                        <i class="fas fa-angle-right"></i> Schrijf een review</a>
                    </button>
                </div>
                <?php endif; ?>

                <?php

                //Get extra info about the category
                $database = db_con();
                $sql = "SELECT * FROM `review` WHERE ProductID=:productid";
                $stmt = $database->prepare($sql);
                $stmt->execute( [
                ':productid' => $artikelid,
                ]);
                $reviews= $stmt->fetchAll(PDO::FETCH_ASSOC);
                $database = null;

                ?>
                <div class="wrap-collabsible">
                    <input id="collapsible" class="toggle" type="checkbox">
                    <label for="collapsible" class="lbl-toggle">Reviews</label>
                    <div class="collapsible-content">
                        <?php foreach ($reviews as $review) {
                            $database = db_con();
                            $sql = "SELECT * FROM `user` WHERE ID=:userid";
                            $stmt = $database->prepare($sql);
                            $stmt->execute( [
                                ':userid' => $review['UserID']
                                ]);
                            $user= $stmt->fetch(PDO::FETCH_ASSOC);

                            echo('<div class="content-inner"><p><em>');
                            echo($review['Date']);
                            echo('</em> <br> <h3>') ;
                            echo($review['Score']);
                            echo('<span class="fa fa-star"></span> door <strong>');
                            echo($user['UserName']);
                            echo('</strong><br><br></h3>');
                            echo($review['Review']);
                            echo('</p></div>');
                        } ?>
                    </div>
                </div>
            </section>