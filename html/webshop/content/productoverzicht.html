<!--========================
Page: Productoverview
Template Name: TuneShop
Author: Jan Willem Lenting, Lotus ter Haar
Bronnen:
Associated files: producten CSS
==========================-->
<?php

$categorieid = 22; // Standaard bij Piano's beginnen
$aantal = 10; // Standaard aantal per pagina
$pagina = 1; //Standaard beginpagina
$totalpages = 1;

if (isset($queryresolved['zoeken']) && !empty($queryresolved['zoeken'])) {
    $zoeken=$queryresolved['zoeken'];
}

if (isset($queryresolved['categorieid']) && !empty($queryresolved['categorieid'])) {
    //Get extra info about the category
    $database = db_con();
    $sql = "SELECT `CategoryID`,`CategoryName`,`MainCategoryID` FROM `category` WHERE Disabled!=1 AND CategoryID=:CategoryID;";
    $stmt = $database->prepare($sql);
    $stmt->execute( [
        ':CategoryID' => $queryresolved['categorieid'],
    ]);
    $categorieinfo = $stmt->fetch(PDO::FETCH_ASSOC);
    $database=null;
    if (isset($categorieinfo['CategoryID']))
        $categorieid=$categorieinfo['CategoryID'];
    else
        $categorieid=0;

    if (isset($categorieinfo['CategoryNaam']))
        $categorienaam=$categorieinfo['CategoryNaam'];
}

if (isset($queryresolved['aantal']) && !empty($queryresolved['aantal']) && is_numeric($queryresolved['aantal'])) {
    $aantal=$queryresolved['aantal'];
}

if (isset($queryresolved['pagina']) && !empty($queryresolved['pagina']) && is_numeric($queryresolved['pagina'])) {
    $pagina=$queryresolved['pagina'];
}

// Winkelwagen
$toevoegenid=0;

if (isset($queryresolved['toevoegen']) && !empty($queryresolved['toevoegen']) && is_numeric($queryresolved['toevoegen']) && isLoggedin()) {

    $toevoegenid=$queryresolved['toevoegen'];

    //Ophalen uit database
    $database = db_con();
    $sql = "SELECT `ID`,`SKU`, `ProductName`, `Price`, `Stock` FROM `product` WHERE Disabled!=1 AND ID=".$toevoegenid.";";
    $stmt = $database->prepare($sql);
    $stmt->execute();
    $articleinfo = $stmt->fetch(PDO::FETCH_ASSOC);
    $database=null;
    $bestelling = array(
        'ID' => $articleinfo['ID'],
        'Aantal' => 1,
        'SKU' => $articleinfo['SKU'],
        'Omschrijving' => $articleinfo['ID'].'-'.$articleinfo['ProductName'],
        'Prijs' => $articleinfo['Price'],
    );

    if ($articleinfo['Stock']>=1) {
        $_SESSION['shoppingcart'][$articleinfo['ID']] = $bestelling;
        $_SESSION['infobox']='Artikel '.$articleinfo['SKU'].' - '.$articleinfo['ProductName']. ' toegevoegd aan winkelmand.';
    }
    else {
        $_SESSION['errorbox']='Artikel '.$articleinfo['SKU'].' - '.$articleinfo['ProductName']. ' is niet op vooraad en kan helaas niet besteld worden';
    }
    unset ($queryresolved['toevoegen']);
}

?>
<!-- Content -->
<?php if ((isset($_SESSION['infobox']) && !empty($_SESSION['infobox']))): ?>
<div class="alert info">
    <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
        <?php echo $_SESSION['infobox']; ?>
</div>
<?php unset($_SESSION['infobox']); endif; ?>

<?php if ((isset($_SESSION['errorbox']) && !empty($_SESSION['errorbox']))): ?>
<div class="alert error">
    <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
        <?php echo $_SESSION['errorbox']; ?>
</div>
<?php unset($_SESSION['errorbox']); endif; ?>

<section class="content">
    <form method="get" class="search-form">
        <input type="text" name="zoeken" <?php if (isset($zoeken)) echo ('value="'.$zoeken.'" '); ?>placeholder="Zoektermen ingeven">
        <button type="submit"><i class="fa fa-search"></i></button>
    </form>

    <section class="flex-wrapper">

        <section class="flex-container">
            <section class="flex-container-column">
                <h1 id="categoryTitle">Categorie</h1>
                <nav class="categoryMenu" id="categoryMenu">
                    <?php
                    // Show Maincategories
                    $database = db_con();
                    $sql = "SELECT `CategoryName`, `MainCategoryID` FROM `maincategory` WHERE Disabled!=1 ORDER BY `CategoryOrder` ASC";
                    $stmt = $database->prepare($sql);
                    $stmt->execute();
                    $categories = $stmt->fetchAll(PDO::FETCH_ASSOC);
                    $database=null;

                    foreach ($categories as $categoryName) {
                    ?>

                    <div class="tab">
                        <?php
                        if (isset($categorieinfo['MainCategoryID']) && $categorieinfo['MainCategoryID'] == $categoryName['MainCategoryID'])
                            echo '<input id="tab-' . $categoryName['MainCategoryID'] . '" type="checkbox" checked name="tabs">';
                        else {
                            echo '<input id="tab-' . $categoryName['MainCategoryID'] . '" type="checkbox" name="tabs">';
                        }

                        echo('<label for="tab-' . $categoryName['MainCategoryID'] . '">' . $categoryName['CategoryName']
                        . '</label>');

                        // Show Subcategories
                        $database = db_con();
                        $sqlQuery = "SELECT * FROM `category` WHERE Disabled !=1 AND `MainCategoryID`=:categoryID ORDER BY `CategoryOrder` ASC";
                        $query = $database->prepare($sqlQuery);
                        $query->execute(['categoryID' => $categoryName['MainCategoryID']]);
                        $subcategories = $query->fetchAll(PDO::FETCH_ASSOC);
                        $database=null;

                        echo('
                        <div class="tab-content">');
                            foreach($subcategories as $subcategory){
                               $active='';
                               if (isset($categorieinfo['CategoryID']) && $categorieinfo['CategoryID'] ==  $subcategory['CategoryID']) {
                                    echo ('<a href="?'.'categorieid=' . $subcategory['CategoryID'] . '&categorienaam='.$subcategory['CategoryName'].'" class="active"> '.$subcategory['CategoryName'].'</a>');
                               } else {
                                    echo ('<a href="?'.'categorieid=' . $subcategory['CategoryID'] . '&categorienaam='.$subcategory['CategoryName'].'">'.$subcategory['CategoryName'].'</a>');
                               }
                            } ?>
                        </div>

                    </div>
                    <?php  } ?>
                </nav>
            </section>
            <form method="get">
            <?php

            //Load total number of products
            $database = db_con();
            if (isset($zoeken)) {
            $sql = "SELECT * FROM `product` WHERE Disabled!=1 AND ProductName LIKE :zoekterm;";
            }
            else {
            $sql = "SELECT * FROM `product` WHERE Disabled!=1 AND Category=:categorieID;";
            }
            $stmt = $database->prepare($sql);
            if (isset($zoeken)) {
                $stmt->execute( [
                    ':zoekterm' => '%'.$zoeken.'%',
                ] );
            } else {
                $stmt->execute( [
                    ':categorieID' => $categorieid,
                ] );
            }
            $products = $stmt->fetchAll(PDO::FETCH_ASSOC);

            $totaalproducten = count($products);

            if (($totaalproducten-$aantal) <= 0)
                $pagina=1;

            // Now load the products we want to see with the limit
            if ($totaalproducten>0 && $aantal>0)
            $totalpages = round(($totaalproducten/$aantal)+0.4);
            else {
            $pagina=1;
            }

            if ($totaalproducten-$aantal <= 0)
                $pagina=1;

            $offset = ($pagina - 1) * $aantal;

            if (isset($zoeken)) {
                $sql = "SELECT * FROM `product` WHERE Disabled!=1 AND ProductName LIKE :zoekterm LIMIT :offset,:limit";
            } else {
                $sql = "SELECT * FROM `product` WHERE Disabled!=1 AND Category=:categorieID LIMIT :offset,:limit";
            }
            $stmt = $database->prepare($sql);
            if (isset($zoeken)) {
                $zoekterm='%'.$zoeken.'%';
                $stmt->bindParam(':zoekterm', $zoekterm, PDO::PARAM_STR);
                $stmt->bindParam(':offset', $offset, PDO::PARAM_INT);
                $stmt->bindParam(':limit',$aantal, PDO::PARAM_INT);
            } else{
                $stmt->bindParam(':offset', $offset, PDO::PARAM_INT);
                $stmt->bindParam(':limit',$aantal, PDO::PARAM_INT);
                $stmt->bindParam(':categorieID',$categorieid, PDO::PARAM_INT);
                
            }
            $stmt->execute();
            $products = $stmt->fetchAll(PDO::FETCH_ASSOC);

            $database = null; #RESET database session

                //Keep old querystring values
                if (isset($queryresolved)){
                    foreach ($queryresolved as $key => $value ) {
                        if ($key!="aantal")
                            echo ('<input type="hidden" name="'.$key.'" value="'.$value.'">');
                    }
                }
                ?>
            <section class="flex-container-column">
                <div class="product-option-chooser">
                    <p class="productAmountItem startMargin"><?php echo ($totaalproducten)?> Producten <?php if (isset($zoeken)) {echo ('Gevonden ');} if ($totaalproducten>1) { echo ('| Toon</p> '); ?>

                    <select class="productAmountItem" name="aantal" onchange="this.form.submit()">
                        <?php
                        $numberlist = array (); //Because we have too little products some extra choices
                        
                        if ($totaalproducten>=1)
                            array_push($numberlist , 1);

                        if ($totaalproducten>=2) //Because we have too little products some extra choices
                            array_push($numberlist , 2);

                        if ($totaalproducten>=3) //Because we have too little products some extra choices
                            array_push($numberlist , 3);

                        if (($totaalproducten/5)>1) { //Add number of pages with steps of 5
                            for ($i = 1; $i <= ($totaalproducten/5); $i++) {
                                array_push($numberlist , (5*$i));
                            }
                        }
                        if (!isset($querystring['aantal']) && empty($querystring['aantal'])) {
                                echo ('<option value="" selected>Alles</option>');
                        }
                        foreach ($numberlist as $number) {
                            if (isset($aantal) && $aantal == $number) {
                                echo ('<option value="'.$number.'" selected>'.$number.'</option>');
                            }
                            else
                            {
                                echo ('<option value="'.$number.'">'.$number.'</option>');
                            }
                        } ?>
                    </select>
                    <p class="productAmountItem">per pagina</p>
                </div>
                <?php } ?>


                <section class="flex-container-ImageBoxSmall">
                <?php
foreach ($products as $product) {

    echo('<div class="flex-column">
              <div class="imageBoxSmall"><img src="/webshop/producten/images/'.$product['Picture_Big'].'"
                                              alt="Instrument">');
    echo(' <h1>');

    echo(substr($product['ProductName'],0, 50));
    echo('</h1>');
    echo('<div class="priceline"><h2>');
    echo($product['Price']);
    echo('</h2>');
    if (isLoggedin()) {
        echo ('<button class="shopping-cart-button" name="toevoegen" type="submit" value="'.$product['ID'].'"><span>');
        echo ('<i class="fa fa-cart-plus" aria-hidden="true"></i></span></button>');
    } else {
        echo('<button class="shopping-cart-button" name="registreren" type="submit"><span>');
        echo ('<i class="fa fa-user-plus" aria-hidden="true"></i></span></button>');
    }
    echo('</div>  </div>  </div></form>');

}
?></section>
    <?php

        if ($totalpages>1) {
            echo ('<div class="paginanummering">Pagina ');
            unset ($queryresolved['pagina']);
            $querystring='';

            foreach ($queryresolved as $key => $value ){
                    if (empty($querystring))
                        $querystring = '?'.$key.'='.$value;
                    else
                        $querystring = $querystring.'&'.$key.'='.$value;
            }

            for($i = 1; $i <= $totalpages; ++$i) {
                echo ('<A HREF="'.$querystring.'&pagina='.$i.'">'.$i.'</A> ');
            }
            echo ('</div>');
        }?>
            </section>
        </section>
    </section>
</section>