<!--========================
Page: Productoverview
Template Name: TuneShop
Author: Jan Willem Lenting, Lotus ter Haar
Bronnen:
Associated files: producten CSS
==========================-->
<PRE>
    <?php

    ?>
</PRE>
<!-- Content -->
<section class="content">
    <form class="search-form" action="action_page.php">
        <input type="text" name="search" placeholder="Zoektermen ingeven">
        <button type="submit"><i class="fa fa-search"></i></button>
    </form>
    <section class="flex-wrapper">

        <section class="flex-container">
            <section class="flex-container-column">
                <h1 id="categoryTitle">Categorie</h1>
                <nav class="categoryMenu" id="categoryMenu">
                    <?php
                    $categorieid = 1; // Standaard bij Piano's beginnen
                    $aantal = 10; // Standaard aantal
                    $pagina = 1; //Standaard beginpagina

                    parse_str($_SERVER['QUERY_STRING'], $queryresolved);
                    if (isset($queryresolved['categorieid']) && !empty($queryresolved['categorieid'])) {
                        //Get extra info about the category
                        $database = db_con();
                        $sql = "SELECT `CategoryID`,`CategoryName`,`MainCategoryID` FROM `category` WHERE Disabled!=1 AND CategoryID=:CategoryID;";
                        $stmt = $database->prepare($sql);
                        $stmt->execute( [
                            ':CategoryID' => $queryresolved['categorieid'],
                        ]);
                        $categorieinfo = $stmt->fetch(PDO::FETCH_ASSOC);
                        $database=null;
                        if (isset($categorieinfo['CategoryID']))
                            $categorieid=$categorieinfo['CategoryID'];
                        else
                            $categorieid=0;
                    }

                    if (isset($queryresolved['aantal']) && !empty($queryresolved['aantal'])) {
                        $aantal=$queryresolved['aantal'];
                    }

                    if (isset($queryresolved['pagina']) && !empty($queryresolved['pagina'])) {
                        $pagina=$queryresolved['pagina'];
                    }

                    $toevoegenid=0;
                    if (isset($queryresolved['toevoegen']) && !empty($queryresolved['toevoegen']) && isLoggedin()) {
                        $toevoegenid=$queryresolved['toevoegen'];
                        $database = db_con();
                        $sql = "SELECT `ID`,`SKU`, `ProductName`, `Price`, `Stock` FROM `product` WHERE Disabled!=1;";
                        $stmt = $database->prepare($sql);
                        $stmt->execute();
                        $articleinfo = $stmt->fetch(PDO::FETCH_ASSOC);
                        $database=null;
                        $bestelling = array(
                            'ID' => $articleinfo['ID'],
                            'Aantal' => 1,
                            'SKU' => $articleinfo['SKU'],
                            'Omschrijving' => $articleinfo['ProductName'],
                            'Prijs' => $articleinfo['Price'],
                        );

                        //if not empty
                        if(!empty($_SESSION['Winkelwagen']))
                        {
                        //and if session Winkelwagen same
                        if(isset($_SESSION['Winkelwagen'][$articleinfo['ID']]) == $articleinfo['ID'] && $articleinfo['Stock']>1) {
                            $_SESSION['Winkelwagen'][$articleinfo['ID']]['Aantal']++;
                        } else {
                            //if not same put new string
                            $_SESSION['Winkelwagen'][$articleinfo['ID']] = $bestelling;
                        }
                        } else  {
                            $_SESSION['Winkelwagen'] = array();
                            $_SESSION['Winkelwagen'][$articleinfo['ID']] = $bestelling;
                        }    //if not empty
                        if(!empty($_SESSION['Winkelwagen']))
                        {
                            //and if session Winkelwagen same
                            if(isset($_SESSION['Winkelwagen'][$articleinfo['ID']]) == $articleinfo['ID'] && $articleinfo['Stock']>1) {
                            $_SESSION['Winkelwagen'][$articleinfo['ID']]['Aantal']++;
                        } else {
                            //if not same put new string
                            $_SESSION['Winkelwagen'][$articleinfo['ID']] = $bestelling;
                        }
                        } else  {
                            $_SESSION['Winkelwagen'] = array();
                            $_SESSION['Winkelwagen'][$articleinfo['ID']] = $bestelling;
                        }
                    }

                    $database = db_con();
                    $sql = "SELECT `CategoryName`, `MainCategoryID` FROM `maincategory` WHERE Disabled!=1 ORDER BY `CategoryOrder` ASC";
                    $stmt = $database->prepare($sql);
                    $stmt->execute();
                    $categories = $stmt->fetchAll(PDO::FETCH_ASSOC);
                    $database=null;

                    foreach ($categories as $categoryName) {
                    ?>
                    <div class="tab">
                        <?php
                        if (isset($categorieinfo['MainCategoryID']) && $categorieinfo['MainCategoryID'] == $categoryName['MainCategoryID'])
                            echo '<input id="tab-' . $categoryName['MainCategoryID'] . '" type="checkbox" checked name="tabs">';
                        else {
                            echo '<input id="tab-' . $categoryName['MainCategoryID'] . '" type="checkbox" name="tabs">';
                        }

                        echo('<label for="tab-' . $categoryName['MainCategoryID'] . '">' . $categoryName['CategoryName']
                        . '</label>');


                        $database = db_con();
                        $sqlQuery = "SELECT * FROM `category` WHERE Disabled !=1 AND `MainCategoryID`=:categoryID ORDER BY `CategoryOrder` ASC";
                        $query = $database->prepare($sqlQuery);
                        $query->execute(['categoryID' => $categoryName['MainCategoryID']]);
                        $subcategories = $query->fetchAll(PDO::FETCH_ASSOC);
                        $database=null;

                        echo('
                        <div class="tab-content">');
                            foreach($subcategories as $subcategory){
                               $active='';
                               if (isset($categorieinfo['CategoryID']) && $categorieinfo['CategoryID'] ==  $subcategory['CategoryID']) {
                                    echo ('<a href="?categorieid=' . $subcategory['CategoryID'] . '&categorienaam='.$subcategory['CategoryName'].'" class="active"> '.$subcategory['CategoryName'].'</a>');
                               } else {
                                    echo ('<a href="?categorieid=' . $subcategory['CategoryID'] . '&categorienaam='.$subcategory['CategoryName'].'">'.$subcategory['CategoryName'].'</a>');
                               }
                            } ?>
                        </div>

                    </div>
                    <?php  }?>
                </nav>
            </section>
            <?php

            $offset = ($pagina - 1) * $aantal;
            $database = db_con();
            $sql = "SELECT * FROM `product` WHERE Disabled!=1 AND Category=:categorieID;";
            $stmt = $database->prepare($sql);
            $stmt->execute( [
            ':categorieID' => $categorieid,
            ] );
            $products = $stmt->fetchAll(PDO::FETCH_ASSOC);

            $totaalproducten = count($products);

            $sql = "SELECT * FROM `product` WHERE Disabled!=1 AND Category=:categorieID LIMIT :offset,:limit";
            $stmt = $database->prepare($sql);
            $stmt->bindParam(':offset', $offset, PDO::PARAM_INT);
            $stmt->bindParam(':limit',$aantal, PDO::PARAM_INT);
            $stmt->bindParam(':categorieID',$categorieid, PDO::PARAM_INT);
            print ($sql);
            $stmt->execute( );
            $products = $stmt->fetchAll(PDO::FETCH_ASSOC);

            $database = null; #RESET database session

            ?>
            <section class="flex-container-column">
                <div class="product-option-chooser">
                    <p class="productAmountItem startMargin"><?php echo ($totaalproducten)?> Producten | Toon</p>
                    <select class="productAmountItem">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                        <option value="40">40</option>
                        <option value="50">50</option>
                    </select>
                    <p class="productAmountItem">per pagina</p>
                </div>

                <section class="flex-container-ImageBoxSmall">
                <?php
foreach ($products as $product) {

    echo('<div class="flex-column">
              <div class="imageBoxSmall"><img src="/webshop/producten/images/'.$product['Picture_Big'].'"
                                              alt="Instrument">');
    echo(' <h1>');

    $extraspaties = 70 -  strlen($product['ProductName']);
    $productname = $product['ProductName'];

    for ($x = 0; $x <= $extraspaties; $x++) {
        $productname = $productname." ";
    }
    $productname = substr($productname,0, 70);
    $productname = str_replace('  ','&nbsp;&nbsp;',$productname);
    echo($productname);
    echo('</h1>');
    echo('<div class="priceline"><h2>');
    echo($product['Price']);
    echo('</h2>');
    if (isLoggedin()) {
        echo('<a href="/webshop/producten?toevoegen=' . $product['ID'] . '"><button class="shopping-cart-button"><span>');
        echo ('<i class="fa fa-cart-plus" aria-hidden="true"></i></span></button></a>');
    } else {
        echo('<a href="/webshop/registreer"><button class="shopping-cart-button"><span>');
        echo ('<i class="fa fa-user-plus" aria-hidden="true"></i></span></button></a>');
    }
    echo('</div>  </div>  </div>');
}
?>

                </section>
            </section>
        </section>
    </section>
</section>

</body>
</html>