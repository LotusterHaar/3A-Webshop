<!--========================
Page: Productoverview
Template Name: TuneShop
Author: Jan Willem Lenting, Lotus ter Haar
Bronnen:
Associated files: producten CSS
==========================-->

<!-- Content -->
<section class="content">
    <form class="search-form" action="action_page.php">
        <input type="text" name="search" placeholder="Zoektermen ingeven">
        <button type="submit"><i class="fa fa-search"></i></button>
    </form>
    <section class="flex-wrapper">

        <section class="flex-container">
            <section class="flex-container-column">
                <h1 id="categoryTitle">Categorie</h1>
                <nav class="categoryMenu" id="categoryMenu">
                    <?php
                    $categorieid = 1; // Standaard bij Piano's beginnen
                    $aantal = 10; // Standaard aantal per pagina
                    $pagina = 1; //Standaard beginpagina
                    $totalpages = 1;

                    parse_str($_SERVER['QUERY_STRING'], $queryresolved);
                    if (isset($queryresolved['categorieid']) && !empty($queryresolved['categorieid'])) {
                        //Get extra info about the category
                        $database = db_con();
                        $sql = "SELECT `CategoryID`,`CategoryName`,`MainCategoryID` FROM `category` WHERE Disabled!=1 AND CategoryID=:CategoryID;";
                        $stmt = $database->prepare($sql);
                        $stmt->execute( [
                            ':CategoryID' => $queryresolved['categorieid'],
                        ]);
                        $categorieinfo = $stmt->fetch(PDO::FETCH_ASSOC);
                        $database=null;
                        if (isset($categorieinfo['CategoryID']))
                            $categorieid=$categorieinfo['CategoryID'];
                        else
                            $categorieid=0;
                    }

                    if (isset($queryresolved['aantal']) && !empty($queryresolved['aantal']) && is_numeric($queryresolved['aantal'])) {
                        $aantal=$queryresolved['aantal'];
                    }

                    if (isset($queryresolved['pagina']) && !empty($queryresolved['pagina']) && is_numeric($queryresolved['pagina'])) {
                        $pagina=$queryresolved['pagina'];
                    }

                    // Winkelwagen
                    $toevoegenid=0;
                    if (isset($queryresolved['toevoegen']) && !empty($queryresolved['toevoegen']) && isLoggedin()) {
                        $toevoegenid=$queryresolved['toevoegen'];
                        $database = db_con();
                        $sql = "SELECT `ID`,`SKU`, `ProductName`, `Price`, `Stock` FROM `product` WHERE Disabled!=1;";
                        $stmt = $database->prepare($sql);
                        $stmt->execute();
                        $articleinfo = $stmt->fetch(PDO::FETCH_ASSOC);
                        $database=null;
                        $bestelling = array(
                            'ID' => $articleinfo['ID'],
                            'Aantal' => 1,
                            'SKU' => $articleinfo['SKU'],
                            'Omschrijving' => $articleinfo['ProductName'],
                            'Prijs' => $articleinfo['Price'],
                        );

                        //if not empty
                        if(!empty($_SESSION['Winkelwagen']))
                        {
                        //and if session Winkelwagen same
                        if(isset($_SESSION['Winkelwagen'][$articleinfo['ID']]) == $articleinfo['ID'] && $articleinfo['Stock']>1) {
                            $_SESSION['Winkelwagen'][$articleinfo['ID']]['Aantal']++;
                        } else {
                            //if not same put new string
                            $_SESSION['Winkelwagen'][$articleinfo['ID']] = $bestelling;
                        }
                        } else  {
                            $_SESSION['Winkelwagen'] = array();
                            $_SESSION['Winkelwagen'][$articleinfo['ID']] = $bestelling;
                        }    //if not empty
                        if(!empty($_SESSION['Winkelwagen']))
                        {
                            //and if session Winkelwagen same
                            if(isset($_SESSION['Winkelwagen'][$articleinfo['ID']]) == $articleinfo['ID'] && $articleinfo['Stock']>1) {
                            $_SESSION['Winkelwagen'][$articleinfo['ID']]['Aantal']++;
                        } else {
                            //if not same put new string
                            $_SESSION['Winkelwagen'][$articleinfo['ID']] = $bestelling;
                        }
                        } else  {
                            $_SESSION['Winkelwagen'] = array();
                            $_SESSION['Winkelwagen'][$articleinfo['ID']] = $bestelling;
                        }
                    }

                    // Show Maincategories
                    $database = db_con();
                    $sql = "SELECT `CategoryName`, `MainCategoryID` FROM `maincategory` WHERE Disabled!=1 ORDER BY `CategoryOrder` ASC";
                    $stmt = $database->prepare($sql);
                    $stmt->execute();
                    $categories = $stmt->fetchAll(PDO::FETCH_ASSOC);
                    $database=null;

                    foreach ($categories as $categoryName) {
                    ?>
                    <PRE>
    <?php
print_r($_SERVER['QUERY_STRING']);
print_r($queryresolved);
    ?>
</PRE>

                    <div class="tab">
                        <?php
                        if (isset($categorieinfo['MainCategoryID']) && $categorieinfo['MainCategoryID'] == $categoryName['MainCategoryID'])
                            echo '<input id="tab-' . $categoryName['MainCategoryID'] . '" type="checkbox" checked name="tabs">';
                        else {
                            echo '<input id="tab-' . $categoryName['MainCategoryID'] . '" type="checkbox" name="tabs">';
                        }

                        echo('<label for="tab-' . $categoryName['MainCategoryID'] . '">' . $categoryName['CategoryName']
                        . '</label>');

                        // Show Subcategories
                        $database = db_con();
                        $sqlQuery = "SELECT * FROM `category` WHERE Disabled !=1 AND `MainCategoryID`=:categoryID ORDER BY `CategoryOrder` ASC";
                        $query = $database->prepare($sqlQuery);
                        $query->execute(['categoryID' => $categoryName['MainCategoryID']]);
                        $subcategories = $query->fetchAll(PDO::FETCH_ASSOC);
                        $database=null;

                        echo('
                        <div class="tab-content">');
                            $querystring='';
                            foreach ($queryresolved as $key => $value ){

                                if (!($key=="categorieid" || $key=="categorienaam")) {
                                    $querystring = $querystring.'&'.$key.'='.$value;
                                }
                            }
                            echo ('testquerystring: '.$querystring);

                            foreach($subcategories as $subcategory){
                               $active='';
                               if (isset($categorieinfo['CategoryID']) && $categorieinfo['CategoryID'] ==  $subcategory['CategoryID']) {
                                    echo ('<a href="?'.$querystring .'&categorieid=' . $subcategory['CategoryID'] . '&categorienaam='.$subcategory['CategoryName'].'" class="active"> '.$subcategory['CategoryName'].'</a>');
                               } else {
                                    echo ('<a href="?'.$querystring .'&categorieid=' . $subcategory['CategoryID'] . '&categorienaam='.$subcategory['CategoryName'].'">'.$subcategory['CategoryName'].'</a>');
                               }
                            } ?>
                        </div>

                    </div>
                    <?php  }?>
                </nav>
            </section>
            <?php

            //Load total number of products
            $database = db_con();
            $sql = "SELECT * FROM `product` WHERE Disabled!=1 AND Category=:categorieID;";
            $stmt = $database->prepare($sql);
            $stmt->execute( [
            ':categorieID' => $categorieid,
            ] );
            $products = $stmt->fetchAll(PDO::FETCH_ASSOC);

            $totaalproducten = count($products);

            if (($totaalproducten-$aantal) <= 0)
                $pagina=1;

            // Now load the products we want to see with the limit
            if ($totaalproducten>0 && $aantal>0)
            $totalpages = round($totaalproducten /$aantal);
            else {
            $pagina=1;
            }

            if ($totaalproducten-$aantal <= 0)
                $pagina=1;

            $offset = ($pagina - 1) * $aantal;

            $sql = "SELECT * FROM `product` WHERE Disabled!=1 AND Category=:categorieID LIMIT :offset,:limit";
            $stmt = $database->prepare($sql);
            $stmt->bindParam(':offset', $offset, PDO::PARAM_INT);
            $stmt->bindParam(':limit',$aantal, PDO::PARAM_INT);
            $stmt->bindParam(':categorieID',$categorieid, PDO::PARAM_INT);

            $stmt->execute( );
            $products = $stmt->fetchAll(PDO::FETCH_ASSOC);

            $database = null; #RESET database session

            ?>
            <form method="get">
                <?php
                //Keep old querystring values
                if (isset($queryresolved)){
                    foreach ($queryresolved as $key => $value ) {
                        if ($key!="aantal")
                            echo ('<input type="hidden" name="'.$key.'" value="'.$value.'">');
                    }
                }
                ?>
            <section class="flex-container-column">
                <div class="product-option-chooser">
                    <p class="productAmountItem startMargin"><?php echo ($totaalproducten)?> Producten | Toon</p>

                    <select class="productAmountItem" name="aantal" onchange="this.form.submit()">
                        <option value="1" <?php if (isset($aantal) && $aantal == '1') echo ('selected'); ?>>1</option>
                        <option value="2" <?php if (isset($aantal) && $aantal == '2') echo ('selected'); ?>>2</option>
                        <option value="3" <?php if (isset($aantal) && $aantal == '3') echo ('selected'); ?>>3</option>
                        <option value="10" <?php if (isset($aantal) && $aantal == '10') echo ('selected'); ?>>10</option>
                        <option value="20" <?php if (isset($aantal) && $aantal == '20') echo ('selected'); ?>>20</option>
                        <option value="30" <?php if (isset($aantal) && $aantal == '30') echo ('selected'); ?>>30</option>
                        <option value="40" <?php if (isset($aantal) && $aantal == '40') echo ('selected'); ?>>40</option>
                        <option value="50" <?php if (isset($aantal) && $aantal == '50') echo ('selected'); ?>>50</option>
                    </select>
                    <p class="productAmountItem">per pagina</p>
                </div>
                </form>

                <section class="flex-container-ImageBoxSmall">
                <?php
foreach ($products as $product) {

    echo('<div class="flex-column">
              <div class="imageBoxSmall"><img src="/webshop/producten/images/'.$product['Picture_Big'].'"
                                              alt="Instrument">');
    echo(' <h1>');

    $extraspaties = 70 -  strlen($product['ProductName']);
    $productname = $product['ProductName'];

    for ($x = 0; $x <= $extraspaties; $x++) {
        $productname = $productname." ";
    }
    $productname = substr($productname,0, 70);
    $productname = str_replace('  ','&nbsp;&nbsp;',$productname);
    echo($productname);
    echo('</h1>');
    echo('<div class="priceline"><h2>');
    echo($product['Price']);
    echo('</h2>');
    if (isLoggedin()) {
        echo('<a href="/webshop/producten?toevoegen=' . $product['ID'] . '"><button class="shopping-cart-button"><span>');
        echo ('<i class="fa fa-cart-plus" aria-hidden="true"></i></span></button></a>');
    } else {
        echo('<a href="/webshop/registreer"><button class="shopping-cart-button"><span>');
        echo ('<i class="fa fa-user-plus" aria-hidden="true"></i></span></button></a>');
    }
    echo('</div>  </div>  </div>');
}
?></section><div class="paginanummering">Pagina <?php
            $querystring='';
            foreach ($queryresolved as $key => $value ){
                if ($key!="pagina")
                    $querystring = '&'.$querystring.$key.'='.$value;
            }
            if ($totalpages>0) {
            for($i = 1; $i <= $totalpages; ++$i) {
                if (empty($_SERVER['QUERY_STRING']))
                    echo ('<A HREF="?&pagina='.$i.'">'.$i.'</A> ');
                else
                    echo ('<A HREF="?'.$querystring.'&pagina='.$i.'">'.$i.'</A> ');
            }}
            else
            echo 1;
            ?>
              </div>
            </section>
        </section>
    </section>
</section>